# Express
详细文档参考   
1.腾讯云API参考手册 https://cloud.tencent.com/developer/section/1489347   
2.Express中文网 http://www.expressjs.com.cn/4x/api.html

## 1、路由基本使用
```js
    const express = require('express')
    let app = new express();
    app.get('/',(req,res)=>{
        res.send('我是express创建的实例')
    })
    app.post('/',(req,res)=>{
        res.send('我也是')
    })
    //router.js
    let router = express.router();
    router.get('./',(req,res)=>{
        res.send('我是express创建的实例')
    })
    //可以链式调用
    .post('./',(req,res)=>{
        res.send('我也是')
    })
    router.get('/index.html',(req,res)=>{
        res.send('我也是')
    })
    module.exports = router;
    //app.js
    let app =new express();
    app.use(require('./router.js'))//app.use(router)
    app.listen(8888,()=>{console.log('port on 8888')})
```
## 2、静态资源,模板引擎,跨域
express-static静态资源,express-art-template模板引擎,跨域cors
```js
    const express = require('express')
    const art = require('express-art-template')
    const cors = require('cors')
    let app  = new express();
    //可以通过http://localhost:8888/img/1.jpg  =>服务器目录/public/img/1.jpg
    app.use(express.static('public'))/* 静态化public文件夹下的静态文件 */
    app.use(cors())/* 跨域 */
    aap.engine('html',art)//html=>extension扩展名 art=>模板引擎
    app.set('view options', {
        debug: process.env.NODE_ENV !== 'production'
    });
    //使用方式
    app.get('/',(req,res)=>{
        //res.render取代了res.end，其内部会end
        //res.render('filepath')默认会去/views/下面查找静态文件
        res.render('./index.html',{})/* 第2个参数对象会成为模板页面的全局对象*/
    })
```
## 3、GET请求参数,POST请求参数,动态路由参数
 ### 3.1 GET请求参数
 ```js
    const express = require('express');
    /* /index?a=1&b=2 */
    aapp.get('/index',(req,res,next)=>{
        res.send({
            a:req.query.a,
            b:req.query.b,
        })
    })
```
 ### 3.2 POST请求参数
 ```js
    const express = require('express');
    /* /index */ /* formData = { a:1 , b:2 } */
    aapp.post('/index',(req,res,next)=>{
        res.send({
            a:req.body.a,
            b:req.body.b,
        })
    })
```
 ### 3.2 动态路由参数
 ```js
    const express = require('express');
    /* /index */ /* formData = { a:1 , b:2 } */
    aapp.post('/index/:id',(req,res,next)=>{
        res.send({
            id:req.params.id
        })
    })
```



## 4 案列: mongose基本crud
```js
/* 
 express + mongoose 
*/
const express = require('express');
const cors = require('cors')
const mongoose = require('mongoose');
mongoose.connect('mongodb://localhost:27017/test',{useNewUrlParser:true})
//建立products 表,schema表约束
const Product =  mongoose.model("Product",new mongoose.Schema({
    title:String,
}))
//  往product表里面插入数据
// 表中的数据有一个会有 _id字段 _v版本
// Product.insertMany([
//     {title:'小米'},
//     {title:'华为'},
//     {title:'荣耀'},
//     {title:'红米'},
//     {title:'魅族'},
// ])
const app = express();
app.use(express.json())
// mongoose 查询
app.get('/product',async (req,res)=>{
    // let data = await Product.find() //查询所有
    // let data = await Product.find().limit(2) //查询两条
    // let data = await Product.find().skip(1).limit(2) //跳过一条后,查询两条
    // let data = await Product.find().where({title:'小米'}) //查询title=小米
    // let data = await Product.find().sort({_id:1})//1表示正序,从小到大排,-1表示逆序,从大到小
    let data = await Product.find().sort({_id:1})
    res.send(data)
})

// mongoose 查询
app.get('/product/:id',async (req,res)=>{
    // let data = Product.findOne(req.params.id) //查询一个
    // 根据id来查的话,可以用更好的findById()
    let data = await Product.findById(req.params.id)
    res.send(data)
})

//  mongoose 添加
app.post('/product',async (req,res)=>{
    let data = await Product.create(req.body)
    res.send(data)
})

//  mongoose 修改

// put一般语义表示覆盖,但是至于是覆盖数据还是修改数据具体看代码怎么写
// patch一般语义表示部分修改,但是至于是覆盖数据还是修改数据具体看代码怎么写
app.put('/product/:id',async (req,res)=>{
    const product = await Product.findById(req.params.id);
    console.log({...product})
    product.title = req.body.title;
    await product.save()
    res.send({
        product,
        content:{...product}
    })
})
//  mongoose 删除
app.delete('/product/:id',async (req,res)=>{
    const product = await Product.findById(req.params.id)
    product.delete()
    res.send({
        success:true,
        result:product,
    })
})
app.listen(3000,()=>console.log("listen port 3000,open http://localhost:3000/"))
```



 
## 5 案列: jwt,bcrypt,cookie
```js
/**
    models文件
*/
const mongoose = require('mongoose')
const bcrypt = require('bcrypt')
mongoose.connect('mongodb://localhost:27017/test',{
    useNewUrlParser:true,
    useCreateIndex:true,//tag1 设置unique键值,需要开启这个
})
const User  = mongoose.model('User',mongoose.Schema({
    username:{
        type:String,
        unique:true,//tag1 解决重名注册问题,设置唯一值

    },
    password:{
        type:String,
        set(val){
            return bcrypt.hashSync(val,4)// 对密码进行散列加密
        }
    },
    password_backup:String,
}))
// User.db.dropCollection("users")
module.exports = {
    User,
}
/* 
    jwt鉴权
*/
const express =require('express')
const jwt =require('jsonwebtoken')
const bcrypt = require('bcrypt')
const cookieParser  =require('cookie-parser');
const { User } = require('./models')
const  app = express()
app.use(express.json())  /* content-type: application/json */
app.use(express.urlencoded()) /* content-type: application/x-www-form-urlencoded */
app.use(cookieParser())
app.post('/api/register',async (req,res)=>{
    //解决同名注册问题,可以给mongoose的schema设置unique
    const user = await User.create({
        username:req.body.username,
        password:req.body.password,
        password_backup:req.body.password,
    })
    let cookie_name = req.cookie.name
    res.cookie('name','zhangsan',{maxAge:1000*60*60*24,httpOnly:true})/* httpOnly:true 浏览器无法操作cookie */
    res.send(user)
})
app.post('/api/login',async (req,res)=>{
    const user = await User.findOne({
        username:req.body.username,
    })
    console.log(user,req.body.usernames)
    if(!user){
        return res.status(422).send({
            error:"用户名不存在",
        })
    }
    const isPasswordValid = bcrypt.compareSync(req.body.password,user.password)
    if(isPasswordValid){
    const token = jwt.sign({id:String(user._id)},'12345',{expiresIn:1000*60*60*24}) ;
     res.send({
         user,
         token:token
     })
    }else{
        res.send({
            error:"密码错误"
        })
    }
})
app.get('/api/profile',async (req,res)=>{
    let verify  = jwt.verify(req.header('authorization').split(' ').pop(),'12345')
    let user = await User.findById(verify.id)
    res.send({
        verify,
        user
    })
})
app.listen(4000,()=>console.log('listen prot 4000 open http://localhost:4000/'))
```



## 6 案列: mysql基本curd
```js
const express =require('express')
const mysql = require('mysql')
const art_template = require('express-art-template')

const conn = mysql.createConnection({
    host:'localhost',
    user:'root',
    password:'12345',
    database:'test'
})
const app = express();
app.use(express.json())
//配置视图模板
app.engine('.html',art_template);
//设置视图页面目录
app.set('views','./view')
// 设置静态服务器
app.use('/public',express.static('public'))
//  page route
app.get('/',async(req,res)=>{
    await res.render('index.html',{})
})
app.get('/userlist',async (req,res)=>{
    await res.render('userlist.html',{})
})
//  api route
app.get('/api/user',async (req,res)=>{
    const sql = " select * from user";
    conn.query(sql,(err,data)=>{
        if(err){
            res.send({
                err:'error'
            })
        }else{
            res.send(data)
        }
    })
    

})
app.delete('/api/user/:id',async (req,res)=>{
    const sql = `delete from user where id =?`;
    conn.query(sql,req.params.id,(err,data)=>{
        console.log(err,data)
        if(err){
            res.send({
                err:'error'
            })
        }else{
            res.send({
                msg:'ok',
                data
            })
        }
    })
})
app.post('/api/user/',async (req,res)=>{
    const sql = `insert into user (username,password) 
    values ("${req.body.username}","${req.body.password}" )`;
    conn.query(sql,(err,data)=>{
        if(err){
            res.send({
                err:'error'
            })
        }else{
            res.send({
                msg:'ok'
            }) 
        }
    })
})
app.put('/api/user/:id',async (req,res)=>{
    const sql = `update user set username = "${req.body.username}",
                 password = "${req.body.password}" where id = ${req.params.id}
                `
    conn.query(sql,(err,data)=>{
        if(err){
            res.send({
                err:'error'
            })
        }else{
            res.send({
                msg:'ok'
            })
        }
    })
})
app.listen(4000,()=>console.log(
    'http://localhost:4000/\r\n',
    'http://localhost:4000/userlist',

))
```


## 7 案列: mongoose小练习


## 8 案列: jwt中间件
```js
const verifyRoute = ['/profile','/index']
let jwtMiddleWare = ()=>(req,res,next)=>{
    if(verifyRoute.indexOf(req.path)!==-1){
        if(req.cookies.token){
            let  token = jwt.verify(req.cookies.token,'12345')
            res.state.token = token
            next()
        }else{
            res.send({
                code:-1,
                msg:'token过期或没有token',
            })
        }
    }else{
        next()
    }
}
app.use()
```

































































