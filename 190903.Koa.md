# Koa
## 1.Koa基本使用
```js
const http = require('http')
const Koa = require('koa')
const Router = require('koa-router');
const app  = new Koa();
// app.listen(3000,()=>`listen 3000 http:///localhost:3000/`)
http.createServer(app.callback()).listen(3000,()=>{
    console.log('listen port 3000 \r\n http://localhost:3000/')
})

```
### 2.Koa路由,动态路由,GET,POST,解析body,session,模板引擎
```js
const http = require('http')
const fs = require('fs')
const path =require('path')
const Koa   =require('koa');
const Router = require('koa-router')
const static = require('koa-static')
const staticCache = require('koa-static-cache')
const bodyparser = require('koa-bodyparser')
const koabody = require('koa-body')
const session = require('koa-session')
const artTemplate = require('koa-art-template') // art-template +  koa-art-template
let app = new Koa()
let router =new Router();

artTemplate(app,{
    root:path.resolve(__dirname,'view'),
    extname:'.html',
    debug:process.env.NODE_ENV !== 'production'
})
/* session-cookie */
router.get('/',async (ctx,next)=>{
    ctx.cookies.set('a','b',{signed:true})
    console.log(ctx.cookies.get('a'))
    console.log(ctx.url)
    
    await next()
    console.log(ctx.cookies.get('a'))
    await ctx.render('upload',{
        url:ctx.url/* 请求地址 */
        body:ctx.request.body,/* post请求body */
        query:ctx.request.query,/* get请求的query */
        params:ctx.request.params,/* 动态路由参数 */
    })
})
/* 1.koa-body文件上传 */
router.post('/upload',async(ctx,next)=>{
    let file = ctx.request.files.file;
    let fileReadStream  = fs.createReadStream(file.path)
    let filename = `${Date.now()}_${file.name}`
    let uploadpath = path.resolve("upload/",filename)
    let fileWriteStream = fs.createWriteStream(uploadpath);
    fileReadStream.pipe(fileWriteStream)
    fs.unlink(file.path,(err)=>{
        if(err)console.log(err)
    })
    ctx.body = {
        data:'ok'
    }
})
/* 2.koa-multer文件上传 */
const storage = multer.diskStorage({
    destination:function(req,file,cb){
        cb(null,'public/uploads')
    },// 路径必须要求存在
    filename:function(req,file,cb){
        let [name,extname] = file.originalname.split('.')
        cb(null,Date.now()+name+'.'+'extname')
    }
})
let upload = multer({storage:storage})
router.post('/upload',upload.single('file'),(ctx)=>{
    console.log(ctx.req.file.name,ctx.req.body)
    ctx.body = {
        filename:ctx.req.file.filename,
        body:ctx.req.body,
    }
})
/* 1.koa-body 解析post */
app.use(koabody({
    multipart:true,
    formidable:{
        maxFileSize:2*1024*1024,
        keepExtensions:true,
        // 文件上传路径
        uploadDir:path.resolve(__dirname,'upload')
    }
}))
/* 2.koa-bodyparser 解析post */
app.use(bodyparser());
/* 用于session加密 */
app.keys = ['12345','abc'];
const config = {
    key:"keyforsession",
    maxAge:1000*60*60*24*3,
    signed:true,
    rolling:true,//每次请求强行设置cookie,重置cookie过期时间
    httpOnly:true,
}

/* 1.静态资源 koa-static-cache */
app.use(staticCache(path.resolve(__dirname,'public'),{
    prefix:'/public'
}))
/* 2.静态资源 koa-static*/
app.use(static(path.join(__dirname,'./public')))

/* session cookie中间件 */
app.use(session(config,app));
app.use(router.routes()).use(router.allowedMethods());
http.createServer(app.callback()).listen(3000,()=>console.log("listen port 3000"))
```